#!/usr/bin/env sh

# Autogenerated by Ansible. Manual edits can and will be overwritten,
# please edit the template file and redeploy instead
# I used these two websites extensively when cooking this script:
# https://www.mankier.com/1/virt-install
# https://libvirt.org/formatdomain.html

virt-install \
--name "{{ windows_guest_vm.name }}" \
--virt-type kvm \
--os-variant win10 \
--boot cdrom,hd,menu=on,useserial=on,\
loader={{ windows_guest_ovmf.path }},loader_ro=yes,\
nvram_template={{ windows_guest_ovmf.vars }},\
machine={{ windows_guest_vm.machine }} \
--cpu host-passthrough,cache.mode=passthrough \
--qemu-commandline='-cpu host,topoext={{ windows_guest_cpu.topoext }}' \
--vcpus sockets={{ windows_guest_cpu.sockets }},\
cores={{ windows_guest_cpu.cores }},\
threads={{ windows_guest_cpu.threads }}{% if windows_guest_cpu.set %},\
cpuset="{{ windows_guest_cpu.set }}" \
{% else %} \
{% endif %}
--memory {{ windows_guest_memory }} \
--memorybacking hugepages=yes \
{% for disk in windows_guest_disks.values() %}
--disk path="{{ disk.path }}",\
device={{ disk.device }},\
bus={{ disk.bus }},\
cache={{ disk.cache }},\
discard={{ disk.discard }},\
format={{ disk.format }},\
io={{ disk.io }} \
{% endfor %}
--disk path="{{ windows_guest_install_iso }}",\
device=cdrom,\
bus=sata \
--disk path="{{ windows_guest_iso_dir }}/virtio.iso",\
device=cdrom,\
bus=sata \
--network bridge={{ windows_guest_bridge_id }} \
{% for nodedev_id in nodedev_ids.results %}
--host-device={{ nodedev_id.stdout }} \
{% endfor %}
--clock offset=localtime \
--graphics spice,keymap=local \
--noautoconsole \
"$@"
